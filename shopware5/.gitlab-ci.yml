stages:
  - deploy

variables:
  MYSQL_DATABASE: ci_db
  MYSQL_USER: shopware
  MYSQL_PASSWORD: app
  MYSQL_ROOT_PASSWORD: root

before_script:
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh

deploy-staging:
  stage: deploy
  only:
    refs:
      - staging
  image: edbizarro/gitlab-ci-pipeline-php:7.2-alpine
  services:
    - name: mysql:5.7
      alias: mysql
  script:
    - composer install -q
    - php vendor/bin/dep deploy:staging staging

deploy-production:
  stage: deploy
  only:
    refs:
      - master
  image: edbizarro/gitlab-ci-pipeline-php:7.2-alpine
  services:
    - name: mysql:5.7
      alias: mysql
  script:
    - composer install -q
    - php vendor/bin/dep deploy:production production
